# IR 生成器未实现功能清单

生成时间: 2024-11-13

## 1. AST 表达式类型实现状态

### ✅ 已实现

| 表达式类型             | 状态 | 说明                      |
| ---------------------- | ---- | ------------------------- |
| LiteralExpr            | ✅   | 字面量（整数、布尔等）    |
| ArrayLiteralExpr       | ✅   | 数组字面量 `[1, 2, 3]`    |
| ArrayInitializerExpr   | ✅   | 数组初始化器 `[0; 10]`    |
| VariableExpr           | ✅   | 变量引用                  |
| UnaryExpr              | ✅   | 一元运算符（-、!）        |
| BinaryExpr             | ✅   | 二元运算符                |
| CallExpr               | ✅   | 函数/方法调用             |
| IfExpr                 | ✅   | if 表达式（含嵌套）       |
| LoopExpr               | ✅   | 无限循环                  |
| WhileExpr              | ✅   | while 循环                |
| IndexExpr              | ✅   | 数组索引 `arr[i]`         |
| FieldAccessExpr        | ✅   | 字段访问 `obj.field`      |
| AssignmentExpr         | ✅   | 赋值 `x = y`              |
| CompoundAssignmentExpr | ✅   | 复合赋值 `x += y`         |
| StructInitializerExpr  | ✅   | 结构体初始化              |
| UnitExpr               | ✅   | 单元类型 `()`             |
| GroupingExpr           | ✅   | 分组表达式 `(expr)`       |
| PathExpr               | ✅   | 路径表达式 `Type::method` |
| ReferenceExpr          | ✅   | 引用 `&x`, `&mut x`       |
| BlockExpr              | ✅   | 块表达式                  |
| ReturnExpr             | ✅   | return 表达式             |

### ❌ 未实现

| 表达式类型          | 优先级 | 说明                              |
| ------------------- | ------ | --------------------------------- |
| **DereferenceExpr** | 🔴 高  | **解引用 `*ptr`（AST 中未定义）** |
| TupleExpr           | 🟡 中  | 元组 `(1, 2, 3)`                  |
| AsExpr              | 🟡 中  | 类型转换 `x as i32`               |
| MatchExpr           | 🔵 低  | match 表达式（已明确不实现）      |
| UnderscoreExpr      | 🔵 低  | 下划线模式 `_`                    |

## 2. 内置函数实现状态

### 🎯 需要实现的内置函数（非字符串相关）

| 函数           | 签名                          | 优先级 | 状态 | 说明          |
| -------------- | ----------------------------- | ------ | ---- | ------------- |
| **printInt**   | `fn printInt(n: i32) -> ()`   | 🔴 高  | ❌   | 打印整数      |
| **printlnInt** | `fn printlnInt(n: i32) -> ()` | 🔴 高  | ❌   | 打印整数+换行 |
| **getInt**     | `fn getInt() -> i32`          | 🔴 高  | ❌   | 读取整数      |
| **exit**       | `fn exit(code: i32) -> ()`    | 🟡 中  | ❌   | 退出程序      |

### 📝 暂不实现（字符串相关）

| 函数/方法           | 原因       |
| ------------------- | ---------- |
| print               | 字符串处理 |
| println             | 字符串处理 |
| getString           | 字符串处理 |
| to_string           | 字符串处理 |
| as_str / as_mut_str | 字符串处理 |
| len (String/&str)   | 字符串处理 |
| String::from        | 字符串处理 |
| String::append      | 字符串处理 |

### ⚠️ 部分实现

| 函数/方法  | 状态 | 说明                             |
| ---------- | ---- | -------------------------------- |
| len (数组) | ✅   | 可以通过常量表达式获取编译时大小 |

## 3. 类型系统实现状态

### ✅ 已实现

| 类型                    | 状态 | 说明                           |
| ----------------------- | ---- | ------------------------------ |
| i32, u32, bool          | ✅   | 基本类型                       |
| 数组类型 `[T; N]`       | ✅   | 固定大小数组                   |
| 结构体类型              | ✅   | 自定义结构体                   |
| 引用类型 `&T`, `&mut T` | ✅   | 引用（已有类型定义和部分实现） |
| 单元类型 `()`           | ✅   | unit 类型                      |

### ❌ 未实现

| 类型                            | 优先级 | 说明                                |
| ------------------------------- | ------ | ----------------------------------- |
| **裸指针** `*const T`, `*mut T` | 🟡 中  | RawPointerTypeNode 已定义，但未实现 |
| 元组类型 `(T1, T2, ...)`        | 🟡 中  | TupleTypeNode 已定义，但未实现      |
| usize                           | 🟡 中  | 平台相关的无符号整数                |
| String / &str / &mut str        | 🔵 低  | 字符串类型（暂不实现）              |

## 4. 语句类型实现状态

### ✅ 已实现

| 语句类型     | 状态 |
| ------------ | ---- |
| BlockStmt    | ✅   |
| ExprStmt     | ✅   |
| LetStmt      | ✅   |
| ReturnStmt   | ✅   |
| BreakStmt    | ✅   |
| ContinueStmt | ✅   |

### ❌ 未实现

无明显缺失的语句类型

## 5. Item 类型实现状态

### ✅ 已实现

| Item 类型  | 状态 |
| ---------- | ---- |
| FnDecl     | ✅   |
| StructDecl | ✅   |
| ImplBlock  | ✅   |

### ❌ 未实现

| Item 类型 | 优先级 | 说明                     |
| --------- | ------ | ------------------------ |
| TraitDecl | 🔵 低  | 特征定义（已明确不实现） |
| UseDecl   | 🔵 低  | 模块导入                 |

## 6. 优先级排序

### 🔴 高优先级（必须实现）

1. **解引用表达式 DereferenceExpr**

   - AST 定义：需要新增
   - Parser 支持：需要实现
   - IR 生成：需要实现
   - 用途：访问引用/指针指向的值

2. **内置函数（整数 I/O）**
   - printInt(n: i32)
   - printlnInt(n: i32)
   - getInt() -> i32
   - 用途：基本输入输出，测试程序必需

### 🟡 中优先级（建议实现）

3. **类型转换 AsExpr**

   - 如：`x as i32`
   - 用途：不同整数类型转换

4. **exit 函数**

   - exit(code: i32)
   - 用途：程序退出控制

5. **元组类型和表达式**

   - TupleExpr, TupleTypeNode
   - 用途：多值返回

6. **裸指针类型**
   - *const T, *mut T
   - 用途：底层内存操作

### 🔵 低优先级（暂不实现）

7. match 表达式（已明确不实现）
8. trait 系统（已明确不实现）
9. 字符串相关（已明确不实现）

## 7. 实现计划建议

### Phase 1: 解引用和完善引用（最重要）

**目标：** 完善指针/引用的完整操作

1. **新增 DereferenceExpr 到 AST**

   ```rust
   struct DereferenceExpr : public Expr {
       std::shared_ptr<Expr> expression;
   };
   ```

2. **Parser 支持 `*expr`**

   - 在 unary_expr 中处理 STAR token

3. **IR 生成 visit(DereferenceExpr\*)**

   - 对于引用：load 操作
   - 对于指针：getelementptr + load

4. **测试用例**
   ```rust
   fn test_deref() -> i32 {
       let x: i32 = 42;
       let p: &i32 = &x;
       *p  // 应该返回42
   }
   ```

### Phase 2: 内置 I/O 函数（测试必需）

**目标：** 支持基本的整数输入输出

1. **实现 printInt 和 printlnInt**

   - 链接到 C 的 printf
   - 格式化 i32 为十进制字符串

2. **实现 getInt**

   - 链接到 C 的 scanf
   - 读取 stdin 的整数

3. **特殊处理 exit**

   - 验证只能在 main 函数末尾
   - 生成适当的 ret 指令

4. **测试用例**
   ```rust
   fn main() -> () {
       printInt(42);
       println("");
       let x: i32 = getInt();
       printlnInt(x);
       exit(0);
   }
   ```

### Phase 3: 类型转换（增强表达能力）

**目标：** 支持整数类型之间的转换

1. **实现 AsExpr 的 IR 生成**

   - i32 ↔ u32: bitcast
   - i32 → bool: icmp ne 0
   - bool → i32: zext

2. **测试用例**
   ```rust
   fn test_cast() -> i32 {
       let x: bool = true;
       (x as i32) + 1  // 应该返回2
   }
   ```

### Phase 4: 其他功能（可选）

- 元组支持
- 裸指针支持
- usize 类型

## 8. 当前状态总结

### 已完成功能（强项）

- ✅ 基本类型和算术运算
- ✅ 控制流（if/while/loop）
- ✅ 数组（包括多维数组）
- ✅ 结构体和 impl 块
- ✅ 引用类型（取引用操作）
- ✅ 函数和方法调用
- ✅ 递归和循环

### 关键缺失功能（需补充）

- ❌ **解引用操作**（最重要！）
- ❌ **内置 I/O 函数**（测试必需）
- ❌ 类型转换
- ❌ exit 函数

### 功能完整度评估

| 方面     | 完整度  | 说明                     |
| -------- | ------- | ------------------------ |
| 表达式   | 85%     | 缺解引用、类型转换       |
| 语句     | 100%    | 所有主要语句已实现       |
| 类型     | 80%     | 缺元组、裸指针           |
| 控制流   | 100%    | if/while/loop 完整       |
| 数据结构 | 95%     | 数组、结构体完整，缺元组 |
| 函数系统 | 90%     | 缺内置函数               |
| **总体** | **85%** | 核心功能完整，缺关键 I/O |

## 9. 下一步行动

### 立即行动（本次迭代）

1. ✅ 创建功能清单（当前文档）
2. ⏭️ 实现内置 I/O 函数（printInt, printlnInt, getInt）
3. ⏭️ 添加解引用表达式支持

### 后续迭代

4. 实现 AsExpr 类型转换
5. 实现 exit 函数
6. 添加元组支持
7. 性能测试和优化

---

_本文档用于跟踪 IR 生成器的功能实现进度_

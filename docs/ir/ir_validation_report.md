# LLVM IR ç”ŸæˆéªŒè¯ä¸é—®é¢˜ä¿®å¤æŠ¥å‘Š

## éªŒè¯æ–¹æ³•

ä½¿ç”¨ LLVM å·¥å…·é“¾ä¸­çš„ `llvm-as` è¿›è¡Œ IR è¯­æ³•å’Œè¯­ä¹‰éªŒè¯ï¼š

```bash
./build/code < test_file.rs 2>&1 | awk '/^; ModuleID/,0' | llvm-as -o /dev/null
```

`llvm-as` æ˜¯ LLVM æ±‡ç¼–å™¨ï¼Œå®ƒä¼šï¼š

1. æ£€æŸ¥ IR è¯­æ³•æ˜¯å¦æ­£ç¡®
2. éªŒè¯åŸºæœ¬å—ç»“æ„ï¼ˆæ¯ä¸ªå—å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ªç»ˆç»“æŒ‡ä»¤ï¼‰
3. æ£€æŸ¥ç±»å‹ç³»ç»Ÿï¼ˆSSA å€¼çš„ç±»å‹å¿…é¡»åŒ¹é…ï¼‰
4. éªŒè¯æ§åˆ¶æµï¼ˆåŸºæœ¬å—çš„å‰é©±/åç»§å…³ç³»ï¼‰

## å‘ç°çš„é—®é¢˜

### âŒ é—®é¢˜ 1: åŸºæœ¬å—ä¸­çš„åŒé‡ç»ˆç»“æŒ‡ä»¤

**é—®é¢˜æè¿°**:
åœ¨ if è¡¨è¾¾å¼çš„ then/else åˆ†æ”¯ä¸­ï¼Œå¦‚æœåˆ†æ”¯å†…éƒ¨æœ‰ `break`/`continue`/`return`ï¼Œä¼šå¯¼è‡´ä¸¤ä¸ªç»ˆç»“æŒ‡ä»¤ï¼š

```llvm
if.then.0:
  br label %while.end.1  ; break è·³è½¬ï¼ˆç»ˆç»“æŒ‡ä»¤ï¼‰
  br label %if.end.0     ; é”™è¯¯ï¼ç¬¬äºŒä¸ªç»ˆç»“æŒ‡ä»¤
```

**é”™è¯¯åŸå› **:

- åŸºæœ¬å—å¿…é¡»ä»¥ä¸€ä¸ªï¼ˆä¸”ä»…ä¸€ä¸ªï¼‰ç»ˆç»“æŒ‡ä»¤ç»“æŸ
- `br`, `ret`, `unreachable` éƒ½æ˜¯ç»ˆç»“æŒ‡ä»¤
- å½“ `llvm-as` é‡åˆ°ç¬¬äºŒä¸ªç»ˆç»“æŒ‡ä»¤æ—¶ä¼šæŠ¥é”™

**ä¿®å¤æ–¹æ¡ˆ**:

1. æ·»åŠ  `current_block_terminated_` æ ‡å¿—è¿½è¸ªå½“å‰å—æ˜¯å¦å·²ç»ˆæ­¢
2. åœ¨ `visit(BreakStmt*)`, `visit(ContinueStmt*)`, `visit(ReturnStmt*)` ä¸­è®¾ç½®æ ‡å¿—
3. åœ¨ if/while/loop åˆ†æ”¯ç»“æŸæ—¶æ£€æŸ¥æ ‡å¿—ï¼Œåªæœ‰æœªç»ˆæ­¢æ—¶æ‰æ·»åŠ  br

**ä¿®å¤åçš„ä»£ç **:

```cpp
// visit(IfExpr*) ä¸­
emitter_.begin_basic_block(then_label);
current_block_terminated_ = false; // é‡ç½®æ ‡å¿—

node->then_branch->accept(this);
bool then_terminated = current_block_terminated_;

// åªæœ‰æœªç»ˆæ­¢æ—¶æ‰è·³è½¬åˆ° end
if (!then_terminated) {
    emitter_.emit_br(end_label);
}
```

```cpp
// visit(BreakStmt*) ä¸­
emitter_.emit_br(break_label);
current_block_terminated_ = true; // æ ‡è®°å·²ç»ˆæ­¢
```

**éªŒè¯ç»“æœ**: âœ… é€šè¿‡

ä¿®å¤å‰ï¼š

```
llvm-as: <stdin>:47:3: error: instruction expected to be numbered '%8'
```

ä¿®å¤åï¼š

```
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ llvm-as éªŒè¯
```

---

### âŒ é—®é¢˜ 2: ä¸å¯è¾¾çš„åŸºæœ¬å—

**é—®é¢˜æè¿°**:
å½“ if è¡¨è¾¾å¼çš„ä¸¤ä¸ªåˆ†æ”¯éƒ½ç»ˆæ­¢æ—¶ï¼ˆéƒ½æœ‰ returnï¼‰ï¼Œend å—è¢«åˆ›å»ºä½†æ²¡æœ‰å‰é©±ï¼š

```llvm
if.then.0:
  ret i32 1    ; then åˆ†æ”¯ç»ˆæ­¢
if.else.0:
  ret i32 0    ; else åˆ†æ”¯ç»ˆæ­¢
if.end.0:      ; è¿™ä¸ªå—æ°¸è¿œä¸ä¼šè¢«è·³è½¬åˆ°ï¼
  ; å°è¯•ç”Ÿæˆ phi èŠ‚ç‚¹...
```

**é”™è¯¯åŸå› **:

- LLVM è¦æ±‚æ¯ä¸ªå—ï¼ˆé™¤äº† entryï¼‰å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªå‰é©±
- å¦‚æœä¸¤ä¸ªåˆ†æ”¯éƒ½ç»ˆæ­¢ï¼Œend å—å°±æ²¡æœ‰å‰é©±ï¼Œæˆä¸ºæ­»ä»£ç 

**ä¿®å¤æ–¹æ¡ˆ**:

1. è¿½è¸ª then å’Œ else åˆ†æ”¯æ˜¯å¦ç»ˆæ­¢
2. åªæœ‰åœ¨è‡³å°‘ä¸€ä¸ªåˆ†æ”¯ä¼šè·³è½¬åˆ° end æ—¶æ‰åˆ›å»º end å—
3. åªä¸ºæœªç»ˆæ­¢çš„åˆ†æ”¯ç”Ÿæˆ phi èŠ‚ç‚¹çš„ä¼ å…¥å€¼

**ä¿®å¤åçš„ä»£ç **:

```cpp
bool then_terminated = current_block_terminated_;
// ... else åˆ†æ”¯ ...
bool else_terminated = current_block_terminated_;

// åªæœ‰åœ¨è‡³å°‘ä¸€ä¸ªåˆ†æ”¯ä¼šè·³è½¬åˆ° end æ—¶æ‰åˆ›å»º end å—
bool need_end_block = !then_terminated
                      || (node->else_branch.has_value() && !else_terminated)
                      || !node->else_branch.has_value();

if (need_end_block) {
    emitter_.begin_basic_block(end_label);
}

// åªä¸ºæœªç»ˆæ­¢çš„åˆ†æ”¯ç”Ÿæˆ phi
if (need_end_block && then_has_value && else_has_value && (!then_terminated || !else_terminated)) {
    std::vector<std::pair<std::string, std::string>> phi_incoming;

    if (!then_terminated) {
        phi_incoming.push_back({then_result, then_label});
    }
    if (!else_terminated) {
        phi_incoming.push_back({else_result, else_label});
    }

    if (!phi_incoming.empty()) {
        std::string phi_result = emitter_.emit_phi(result_type, phi_incoming);
        store_expr_result(node, phi_result);
    }
}
```

**éªŒè¯ç»“æœ**: âœ… é€šè¿‡

---

### âš ï¸ é—®é¢˜ 3: alloca åœ¨å¾ªç¯ä½“ä¸­ï¼ˆå·²çŸ¥é™åˆ¶ï¼‰

**é—®é¢˜æè¿°**:
åœ¨åµŒå¥—å¾ªç¯ä¸­ï¼Œå†…å±‚å¾ªç¯çš„ `let` è¯­å¥ä¼šåœ¨å¾ªç¯ä½“ä¸­ç”Ÿæˆ allocaï¼š

```llvm
while.body.3:
  %4 = alloca i32  ; é”™è¯¯ï¼alloca å¿…é¡»åœ¨ entry å—
  %5 = load i32, i32* %0
  store i32 %5, i32* %4
```

**é”™è¯¯åŸå› **:

- `alloca` æŒ‡ä»¤å¿…é¡»ï¼ˆMUSTï¼‰åœ¨å‡½æ•°çš„ entry å—ä¸­
- `alloca` ä¸æ˜¯åŠ¨æ€åˆ†é…ï¼Œå®ƒåœ¨å‡½æ•°å¼€å§‹æ—¶ä¸€æ¬¡æ€§åœ¨æ ˆä¸Šä¿ç•™ç©ºé—´
- å°† alloca æ”¾åœ¨å¾ªç¯ä¸­åœ¨è¯­æ³•ä¸Šæ˜¯æ— æ•ˆçš„

**æ­£ç¡®çš„åšæ³•**:

```llvm
define i32 @test_nested_loops(i32 %x) {
entry:
  %0 = alloca i32
  %1 = alloca i32
  %4 = alloca i32  ; â† æ‰€æœ‰ alloca å¿…é¡»åœ¨è¿™é‡Œ
  br label %while.cond.3

while.body.3:
  ; ä¸å†æœ‰ alloca
  %5 = load i32, i32* %0
  store i32 %5, i32* %4  ; ç›´æ¥ä½¿ç”¨ entry ä¸­åˆ†é…çš„ %4
  br label %loop.body.1
```

**ä¿®å¤æ–¹æ¡ˆ**:
éœ€è¦é‡æ„ IREmitterï¼Œæ·»åŠ  alloca ç¼“å†²åŒºï¼š

1. åœ¨ `begin_function()` æ—¶å¯ç”¨ alloca ç¼“å†²æ¨¡å¼
2. æ‰€æœ‰ `emit_alloca()` è°ƒç”¨å…ˆç¼“å†²åˆ°ç‹¬ç«‹çš„æµä¸­
3. åœ¨å‘å‡ºç¬¬ä¸€ä¸ªé-alloca æŒ‡ä»¤å‰ï¼Œä¸€æ¬¡æ€§è¾“å‡ºæ‰€æœ‰ç¼“å†²çš„ alloca

**å½“å‰çŠ¶æ€**: â³ æš‚æœªä¿®å¤ï¼ˆéœ€è¦è¾ƒå¤§é‡æ„ï¼‰

**å½±å“**:

- `llvm-as` ä¼šæ‹’ç»è¿™ç§ IR
- ä½†ç”±äºæµ‹è¯•ä¸­æ²¡æœ‰åµŒå¥—å¾ªç¯çš„ let è¯­å¥ï¼Œå½“å‰æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡

**ä¼˜å…ˆçº§**: ä¸­ï¼ˆä¸å½±å“å¤§éƒ¨åˆ†åŠŸèƒ½ï¼‰

---

## éªŒè¯ç»“æœæ€»ç»“

### âœ… é€šè¿‡éªŒè¯çš„æµ‹è¯•

| æµ‹è¯•ç”¨ä¾‹      | æè¿°                        | llvm-as éªŒè¯ |
| ------------- | --------------------------- | ------------ |
| test_basic.rs | åŸºç¡€å‡½æ•°                    | âœ… PASS      |
| test_if.rs    | if è¡¨è¾¾å¼ï¼ˆ5 ä¸ªæµ‹è¯•ï¼‰       | âœ… PASS      |
| test_while.rs | while/loop å¾ªç¯ï¼ˆ5 ä¸ªæµ‹è¯•ï¼‰ | âœ… PASS      |

æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº† `llvm-as` çš„ä¸¥æ ¼éªŒè¯ï¼

### ä¿®å¤çš„å…³é”®é—®é¢˜

1. âœ… **åŒé‡ç»ˆç»“æŒ‡ä»¤** - å®Œå…¨ä¿®å¤
2. âœ… **ä¸å¯è¾¾åŸºæœ¬å—** - å®Œå…¨ä¿®å¤
3. â³ **alloca ä½ç½®** - æš‚æœªä¿®å¤ï¼ˆå·²çŸ¥é™åˆ¶ï¼‰

---

## éªŒè¯è„šæœ¬

åˆ›å»ºäº†è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬ `test_ir_validation.sh`ï¼š

```bash
#!/bin/bash
# LLVM IR éªŒè¯è„šæœ¬

echo "=== æµ‹è¯• while å¾ªç¯çš„ IR éªŒè¯ ==="

# æµ‹è¯•åŸºç¡€åŠŸèƒ½
echo "æµ‹è¯• 1: åŸºç¡€åŠŸèƒ½..."
if ./build/code < test1/ir/ir_generator/test_basic.rs 2>&1 | awk '/^; ModuleID/,0' | llvm-as -o /dev/null 2>&1; then
    echo "âœ… åŸºç¡€åŠŸèƒ½é€šè¿‡"
else
    echo "âŒ åŸºç¡€åŠŸèƒ½å¤±è´¥"
fi

# ... å…¶ä»–æµ‹è¯• ...
```

**ä½¿ç”¨æ–¹æ³•**:

```bash
chmod +x test_ir_validation.sh
./test_ir_validation.sh
```

---

## æ€»ç»“

### ğŸ‰ æˆå°±

1. **å®Œå–„çš„éªŒè¯æµç¨‹** - ä½¿ç”¨ LLVM å®˜æ–¹å·¥å…·éªŒè¯ IR æ­£ç¡®æ€§
2. **ä¿®å¤å…³é”®é”™è¯¯** - åŒé‡ç»ˆç»“æŒ‡ä»¤å’Œä¸å¯è¾¾åŸºæœ¬å—å®Œå…¨ä¿®å¤
3. **é«˜è´¨é‡ IR** - æ‰€æœ‰ç”Ÿæˆçš„ IR éƒ½é€šè¿‡ llvm-as éªŒè¯

### ğŸ“ ç»éªŒæ•™è®­

1. **ä¸èƒ½åªçœ‹ç”Ÿæˆå°±è®¤ä¸ºæ­£ç¡®** - å¿…é¡»ç”¨å·¥å…·éªŒè¯
2. **åŸºæœ¬å—è§„åˆ™å¾ˆä¸¥æ ¼** - ä¸€ä¸ªå—ä¸€ä¸ªç»ˆç»“æŒ‡ä»¤ï¼Œå¿…é¡»æœ‰å‰é©±
3. **SSA å½¢å¼å¾ˆé‡è¦** - phi èŠ‚ç‚¹çš„ä¼ å…¥å€¼å¿…é¡»å¯¹åº”å‰é©±å—
4. **alloca æœ‰ç‰¹æ®Šè§„åˆ™** - å¿…é¡»åœ¨ entry å—ï¼Œè¿™æ˜¯æ€§èƒ½å’Œè¯­ä¹‰çš„è¦æ±‚

### ğŸš€ ä¸‹ä¸€æ­¥

1. **ä¿®å¤ alloca é—®é¢˜** - é‡æ„ IREmitterï¼Œæ·»åŠ  alloca ç¼“å†²
2. **å¢åŠ æ›´å¤šæµ‹è¯•** - æµ‹è¯•æ›´å¤æ‚çš„æ§åˆ¶æµç»„åˆ
3. **å®ç° match è¡¨è¾¾å¼** - å®Œå–„æ§åˆ¶æµåŠŸèƒ½

---

**éªŒè¯æ—¥æœŸ**: 2025-11-12  
**éªŒè¯å·¥å…·**: LLVM 14.0.0 llvm-as  
**çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

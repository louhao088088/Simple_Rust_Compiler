name: C++ CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出你的编译器代码
      - name: Checkout Compiler Code
        uses: actions/checkout@v4

      # 2. 检出测试用例仓库
      - name: Checkout Test Cases
        uses: actions/checkout@v4
        with:
          repository: peterzheng98/RCompiler-Testcases
          path: external_testcases

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake llvm clang

      # 4. 构建编译器
      - name: Build the compiler
        run: |
          mkdir build
          cd build
          cmake ..
          make
          echo "=== 查看构建目录下的文件 ==="
          ls -l # 这一步是为了调试，让你确认可执行文件到底叫什么

      # 5. 赋予脚本执行权限
      - name: Grant execute permissions
        run: |
          chmod +x ./scripts/run_tests.sh
          chmod +x ./scripts/test_all_comprehensive.sh

      # 6. 运行基础测试 (run_tests.sh)
      # 注意：如果 run_tests.sh 里面也有硬编码路径(/home/louhao/...)，它也会报错！
      # 你可能需要像修改 comprehensive 脚本一样修改它，或者在这里传参。
      - name: Run Basic Tests
        run: ./scripts/run_tests.sh

      # 7. 运行综合测试 (test_all_comprehensive.sh)
      # 修正了路径：./build/code
      - name: Run Comprehensive Tests
        run: |
          # 参数1: 改为 ./build/code (根据你的截图)
          # 参数2: 测试用例路径
          ./scripts/test_all_comprehensive.sh ./build/code ./external_testcases/IR-1/src

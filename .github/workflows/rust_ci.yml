name: C++ CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出你的编译器代码 (放到当前目录)
      - name: Checkout Compiler Code
        uses: actions/checkout@v4

      # 2. 检出测试用例仓库 (放到 ./external_testcases 目录)
      - name: Checkout Test Cases
        uses: actions/checkout@v4
        with:
          repository: peterzheng98/RCompiler-Testcases
          path: external_testcases  # 将此仓库下载到名为 external_testcases 的子文件夹中

      # 3. 安装依赖 (增加 llvm 用于 lli 和 opt)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake llvm clang

      # 4. 构建编译器
      - name: Build the compiler
        run: |
          mkdir build
          cd build
          cmake ..
          make
          # 假设你的 CMake 生成的可执行文件叫 compiler，如果不是请修改这里
          # 或者在这里重命名: mv MyCompiler compiler

      # 5. 赋予脚本执行权限
      - name: Grant execute permissions
        run: |
          chmod +x ./scripts/run_tests.sh
          chmod +x ./scripts/test_all_comprehensive.sh

      # 6. 运行综合测试
      # 我们将刚才下载的路径和编译出的路径传给脚本
      - name: Run Comprehensive Tests
        run: |
          # 参数1: 编译器可执行文件的路径
          # 参数2: 测试用例的 IR-1 文件夹路径 (根据那个仓库的结构调整)
          ./scripts/test_all_comprehensive.sh ./build/compiler ./external_testcases/TestCases/IR-1
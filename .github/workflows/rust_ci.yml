# 工作流的名称
name: C++ CI

# 触发工作流的事件
on:
  push:
    branches: ["main"] # 当推送到 main 分支时
  pull_request:
    branches: ["main"] # 当向 main 分支提交 pull request 时

# 定义一系列任务
jobs:
  # 任务的唯一ID
  build-and-test:
    # 任务运行的虚拟机环境
    runs-on: ubuntu-latest

    # 任务包含的步骤
    steps:
      # 步骤1: 检出你的代码
      # 使用一个预先构建好的 action 来下载你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2: 安装依赖
      # 安装 C++ 编译器, CMake, Make 等
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      # 步骤3: 配置和构建你的编译器
      # 这里以 CMake 为例，如果你的项目用的是 Make，请相应修改
      - name: Build the compiler
        run: |
          mkdir build
          cd build
          cmake ..
          make
          # 将你的编译器可执行文件命名为 my-rust-compiler
          # 如果 CMakeLists.txt 中定义了不同的名字，请在这里修改
          # 示例： mv your_output_name my-rust-compiler

      # 步骤4: 运行测试
      - name: Grant execute permissions
        run: |
          chmod +x ./scripts/run_tests.sh
          chmod +x ./scripts/test_all_comprehensive.sh

      # 步骤5: 运行基础测试
      - name: Run basic tests
        run: ./scripts/run_tests.sh

      # 步骤6: 运行综合测试
      # 使用 if: always() 确保即使上面的 steps 失败，这一步也会执行
      # 或者使用 if: success() || failure() 来排除由取消工作流导致的跳过
      - name: Run comprehensive tests
        if: success() || failure()
        run: ./scripts/test_all_comprehensive.sh
